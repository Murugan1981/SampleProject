import os
import pandas as pd
from pymongo import MongoClient
from dotenv import load_dotenv
from datetime import datetime
from pymongo.errors import ConnectionFailure, ConfigurationError
import urllib.parse

# STEP 1: Load environment variables
load_dotenv()
MONGO_USERNAME = os.getenv("MONGOUSERNAME")
MONGO_PASSWORD = os.getenv("MONGOPASSWORD")

encoded_user = urllib.parse.quote_plus(MONGO_USERNAME)
encoded_pass = urllib.parse.quote_plus(MONGO_PASSWORD)

# STEP 2: Read Excel input
input_file = r"./shared/input/pegasus_mongo_validation_input.xlsx"
sheet_name = "MongoValidationInput"
df = pd.read_excel(input_file, sheet_name=sheet_name)

output = []

# STEP 3: Iterate rows
for index, row in df.iterrows():
    try:
        mongo_host = row['MongoHost']
        mongo_port = str(row['MongoPort'])  # not used for SRV but kept
        database_name = row['DatabaseName']
        collection_name = row['CollectionName']

        field1 = row['Field1']
        operator1 = row['Operator1']
        value1 = row['Value1']

        field2 = row['Field2']
        operator2 = row['Operator2']
        value2 = row['Value2']

        print(f"\nüîç Processing row {index + 1}: {database_name}.{collection_name} on {mongo_host}")

        # STEP 4: Connect to MongoDB
        mongo_uri = f"mongodb+srv://{encoded_user}:{encoded_pass}@{mongo_host}"
        client = MongoClient(mongo_uri)
        client.admin.command('ping')
        print("‚úÖ Connected")

        db = client[database_name]
        collection = db[collection_name]

        # STEP 5: Build query
        query = {"$and": []}

        # Field1 condition
        if pd.notna(field1) and pd.notna(value1):
            if str(operator1).lower() == "eq":
                query["$and"].append({field1: str(value1)})
            elif str(operator1).lower() == "in":
                query["$and"].append({field1: {"$in": str(value1).split(',')}})

        # Field2 condition
        if pd.notna(field2) and pd.notna(value2):
            if str(operator2).lower() == "eq":
                query["$and"].append({field2: str(value2)})
            elif str(operator2).lower() == "in":
                query["$and"].append({field2: {"$in": str(value2).split(',')}})

        print("üì¶ Query built:", query)

        # STEP 6: Execute query
        result = collection.find_one(query, {"_id": 0})
        if result:
            print("‚úÖ Record found")
            result_status = "Found"
        else:
            print("‚ùå No matching record")
            result_status = "Not Found"

        output.append({
            "MongoHost": mongo_host,
            "Database": database_name,
            "Collection": collection_name,
            "Query": str(query),
            "Result": result_status
        })

    except Exception as e:
        print("‚ùå Error:", str(e))
        output.append({
            "MongoHost": mongo_host,
            "Database": database_name,
            "Collection": collection_name,
            "Query": "ERROR",
            "Result": str(e)
        })

# STEP 7: Write output report
df_out = pd.DataFrame(output)
report_path = "./shared/reports/mongo_dynamic_validation_report.xlsx"
df_out.to_excel(report_path, index=False)
print(f"\n‚úÖ Report generated successfully ‚ûú {report_path}")

