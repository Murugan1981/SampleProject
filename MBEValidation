# trades_bookref_validation.py
import pandas as pd
import os
import requests
import xml.etree.ElementTree as ET
import pyodbc
from dotenv import load_dotenv

# STEP 0: Load .env variables for DB Auth
load_dotenv()
USERNAME = os.getenv("DB_USERNAME")
PASSWORD = os.getenv("DB_PASSWORD")

def load_input_data(file_path, sheet_name):
    return pd.read_excel(file_path, sheet_name=sheet_name)

def get_book_ref_from_cdw(cdw_url):
    try:
        response = requests.get(cdw_url, auth=(USERNAME, PASSWORD), timeout=60, verify=False)
        if response.status_code != 200:
            return None, "CDW Fetch Failed"

        root = ET.fromstring(response.content)
        accounts = root.findall(".//account[@id='HOUSE-ACCOUNT']")
        if not accounts:
            return None, "HOUSE-ACCOUNT not found"

        last_account = accounts[-1]
        book_ref = last_account.findtext("accountids/accountid[@accountidscheme='book-ref']")
        return book_ref, "Success"

    except Exception as e:
        return None, f"Error parsing CDW URL: {e}"

def check_trade_in_file(file_path, trade_id):
    try:
        # Try with common delimiters
        for sep in ["|", ";"]:
            df = pd.read_csv(file_path, sep=sep, dtype=str, engine='python')
            df.columns = [col.strip() for col in df.columns]
            if "M_ORIGIN_RE" in df.columns:
                trade_id = str(trade_id).strip()
                if trade_id in df["M_ORIGIN_RE"].astype(str).str.strip().tolist():
                    return True
                else:
                    return False
        return False
    except Exception as e:
        return False

def validate_book_ref_in_db(server, db, table, column, book_ref):
    try:
        conn_str = f"DRIVER={{SQL Server}};SERVER={server};DATABASE={db};UID={USERNAME};PWD={PASSWORD}"
        with pyodbc.connect(conn_str) as conn:
            cursor = conn.cursor()
            query = f"SELECT 1 FROM {table} WHERE {column} = ?"
            cursor.execute(query, (book_ref,))
            result = cursor.fetchone()
            return result is not None
    except Exception as e:
        return False

def process_row(row):
    file_type = row.get("FileType", "").strip()
    file_name = row.get("Filename", "").strip()
    dest_folder = row.get("DestinationFolder", "").strip()
    trade_ids = str(row.get("Trades", "")).strip().split(",")
    cdw_url_template = row.get("CDWURL", "")
    batch_date = str(row.get("BatchDate", "")).strip()
    db_server = row.get("DatabaseInstanceName", "").strip()
    db_name = row.get("Databasename", "").strip()
    table = row.get("Tablename", "").strip()
    column = row.get("ColumnNameForBookRef", "").strip()

    results = []
    file_path = os.path.join(dest_folder, file_name)

    for trade_id in trade_ids:
        trade_id = trade_id.strip()
        cdw_url = cdw_url_template.replace("{TRADEID}", trade_id).replace("{BatchDate}", batch_date)
        trade_found = "FOUND" if check_trade_in_file(file_path, trade_id) else "MISSING"

        book_ref, comment = get_book_ref_from_cdw(cdw_url)
        if not book_ref:
            book_ref = "-"

        bookref_found = "YES" if validate_book_ref_in_db(db_server, db_name, table, column, book_ref) else "NO"

        result_row = {
            "FileType": file_type,
            "Filename": file_name,
            "TradeID": trade_id,
            "TradeFound": trade_found,
            "CDWURL": cdw_url,
            "BOOKREF_INCDW": book_ref,
            "BookRefFoundINDB": bookref_found,
            "Comment": comment
        }
        results.append(result_row)

    return results

def generate_report(all_results, output_file):
    df = pd.DataFrame(all_results)
    df.to_excel(output_file, index=False)

# Main execution block
if __name__ == "__main__":
    input_file = "shared/input/input_filenames.xlsx"
    sheet_name = "TradesInFile"
    output_file = "shared/reports/trades_validation_report.xlsx"

    df = load_input_data(input_file, sheet_name)
    all_results = []

    for idx, row in df.iterrows():
        row_results = process_row(row)
        all_results.extend(row_results)

    generate_report(all_results, output_file)
    print("âœ… Trade validation complete. Report generated.")
