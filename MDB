import pandas as pd
from pymongo import MongoClient
from datetime import datetime

# STEP 1: Read input Excel
input_file = r"./shared/input/mongo_validation_input.xlsx"
sheet_name = "MongoValidationInput"
df = pd.read_excel(input_file, sheet_name=sheet_name)

validation_results = []

# STEP 2: Loop through each row of Excel
for index, row in df.iterrows():
    mongo_host = row.get("mongoHost")
    mongo_port = row.get("MongoPort")
    db_name = row.get("DatabaseName")
    collection_name = row.get("CollectionName")

    print(f"\nüîç Processing row {index+1}: {db_name}.{collection_name} on {mongo_host}:{mongo_port}")

    # STEP 3: Build dynamic query dictionary
    query_conditions = []
    col_names = df.columns.tolist()

    for i in range(1, 50):  # Support up to 50 dynamic conditions
        field_col = f"Field{i}"
        op_col = f"Operator{i}"
        val_col = f"Value{i}"

        if field_col in col_names and op_col in col_names and val_col in col_names:
            field = str(row.get(field_col)).strip()
            op = str(row.get(op_col)).strip().lower()
            val_raw = str(row.get(val_col)).strip()

            if not field or field.lower() == "nan":
                continue

            # Parse value(s)
            if op in ["in", "nin"]:
                values = [v.strip() for v in val_raw.split(",") if v.strip()]
            else:
                values = val_raw

            # Build Mongo operator condition
            if op == "eq":
                condition = {field: values}
            elif op == "ne":
                condition = {field: {"$ne": values}}
            elif op == "in":
                condition = {field: {"$in": values}}
            elif op == "nin":
                condition = {field: {"$nin": values}}
            elif op == "gt":
                condition = {field: {"$gt": values}}
            elif op == "gte":
                condition = {field: {"$gte": values}}
            elif op == "lt":
                condition = {field: {"$lt": values}}
            elif op == "lte":
                condition = {field: {"$lte": values}}
            else:
                print(f"‚ö†Ô∏è Unsupported operator '{op}' for field '{field}' ‚Äî skipping.")
                continue

            query_conditions.append(condition)

    if not query_conditions:
        print(f"‚ö†Ô∏è No valid query conditions found in row {index+1}, skipping.")
        continue

    mongo_query = {"$and": query_conditions} if len(query_conditions) > 1 else query_conditions[0]
    print(f"üìã Query built: {mongo_query}")

    try:
        # STEP 4: Connect to MongoDB
        mongo_uri = f"mongodb://user123:Pass123@{mongo_host}:{mongo_port}/"
        client = MongoClient(mongo_uri)
        db = client[db_name]
        collection = db[collection_name]

        # STEP 5: Execute query (single hit)
        results = list(collection.find(mongo_query, {"_id": 0}))
        found_count = len(results)

        # STEP 6: Add row to output
        validation_results.append({
            "mongoHost": mongo_host,
            "MongoPort": mongo_port,
            "DatabaseName": db_name,
            "CollectionName": collection_name,
            "Query": str(mongo_query),
            "DocumentsFound": found_count,
            "Status": "Found" if found_count > 0 else "Missing"
        })

        print(f"‚úÖ Found {found_count} document(s).")

    except Exception as e:
        print(f"‚ùå Error processing row {index+1}: {e}")
        validation_results.append({
            "mongoHost": mongo_host,
            "MongoPort": mongo_port,
            "DatabaseName": db_name,
            "CollectionName": collection_name,
            "Query": str(mongo_query),
            "DocumentsFound": "N/A",
            "Status": f"Error: {e}"
        })
        continue

# STEP 7: Export report
output_file = r"./shared/reports/mongo_dynamic_validation_report.xlsx"
df_results = pd.DataFrame(validation_results)
df_results["RunTimestamp"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

df_results.to_excel(output_file, index=False)
print(f"\nüìä Report generated successfully ‚Üí {output_file}")
