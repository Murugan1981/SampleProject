import pandas as pd
from pymongo import MongoClient
from datetime import datetime

# STEP 1: Read input Excel
input_file = r"./shared/input/mongo_validation_input.xlsx"
sheet_name = "MongoValidationInput"
df = pd.read_excel(input_file, sheet_name=sheet_name)

# STEP 2: Prepare empty results list
validation_results = []

# STEP 3: Loop through each row in Excel
for index, row in df.iterrows():
    mongo_host = row["mongoHost"]
    mongo_port = row["MongoPort"]
    db_name = row["DatabaseName"]
    collection_name = row["CollectionName"]
    field_name = row["FieldName"]
    trade_ids_raw = str(row["TradeIDs"]).strip()
    
    if not trade_ids_raw or trade_ids_raw.lower() == "nan":
        print(f"‚ö†Ô∏è No TradeIDs found for row {index+1}, skipping.")
        continue
    
    # Split TradeIDs by comma and strip spaces
    trade_ids = [tid.strip() for tid in trade_ids_raw.split(",") if tid.strip()]
    
    print(f"\nüîç Validating {len(trade_ids)} trades in {db_name}.{collection_name} on {mongo_host}:{mongo_port}")
    
    try:
        # STEP 4: Connect to MongoDB
        # Use dummy credentials for now ‚Äî replace with actual if needed
        mongo_uri = f"mongodb://user123:Pass123@{mongo_host}:{mongo_port}/"
        client = MongoClient(mongo_uri)
        db = client[db_name]
        collection = db[collection_name]
        
        # STEP 5: Query all TradeIDs at once using $in
        query = {field_name: {"$in": trade_ids}}
        found_docs = collection.find(query, {field_name: 1, "_id": 0})
        
        # Convert found TradeIDs to a set for fast lookup
        found_ids = {doc[field_name] for doc in found_docs if field_name in doc}
        
        # STEP 6: Populate results row-wise
        for tid in trade_ids:
            validation_results.append({
                "mongoHost": mongo_host,
                "MongoPort": mongo_port,
                "DatabaseName": db_name,
                "CollectionName": collection_name,
                "FieldName": field_name,
                "TradeID": tid,
                "Status": "Found" if tid in found_ids else "Missing"
            })
        
        print(f"‚úÖ Completed validation for {db_name}.{collection_name}")

    except Exception as e:
        print(f"‚ùå Error validating row {index+1}: {e}")
        # Log all trades from this row as error
        for tid in trade_ids:
            validation_results.append({
                "mongoHost": mongo_host,
                "MongoPort": mongo_port,
                "DatabaseName": db_name,
                "CollectionName": collection_name,
                "FieldName": field_name,
                "TradeID": tid,
                "Status": f"Error: {e}"
            })
        continue

# STEP 7: Export results to Excel
output_file = r"./shared/reports/mongo_trade_validation_report.xlsx"
df_results = pd.DataFrame(validation_results)
df_results["RunTimestamp"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

df_results.to_excel(output_file, index=False)
print(f"\nüìä Validation report generated successfully: {output_file}")
