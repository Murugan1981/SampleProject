import os
import sys
import pandas as pd
from dotenv import load_dotenv

# Make sure we can import from the project root
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))

# Load .env file from root directory
load_dotenv()

# Get mapping file path from .env
mapping_file = os.getenv("SCENARIO_MAPPING_FILE")

# Import all task handlers and helpers
from libs.files_in_folder import run_files_in_folder
from libs.trades_in_file import run_trades_in_file
from libs.CDWHelper import CDWscraper


def execute_scenario(scenario: str, datafile: str, rows: str):
    print(f"\n‚ñ∂Ô∏è Running Scenario: {scenario}")
    print(f"üìÑ Data File: {datafile} | Rows: {rows}")

    match scenario:
        case "FILES_IN_FOLDER":
            run_files_in_folder(datafile=datafile, rows=rows)

        case "TRADES_IN_FILES":
            run_trades_in_file(datafile=datafile, rows=rows)

        case "EXTRACT_CDW":
            try:
                df = pd.read_csv(datafile)
            except Exception as e:
                print(f"‚ùå Failed to read CDW data file: {e}")
                return

            if rows.upper() == "ALL":
                for _, row in df.iterrows():
                    CDWscraper(
                        base_url=row["base_url"],
                        trade_id=row["trade_id"],
                        batch_date=row["batch_date"],
                        output_excel=row["output_excel"]
                    )
            else:
                try:
                    row_index = int(rows)
                    if row_index < len(df):
                        row = df.iloc[row_index]
                        CDWscraper(
                            base_url=row["base_url"],
                            trade_id=row["trade_id"],
                            batch_date=row["batch_date"],
                            output_excel=row["output_excel"]
                        )
                    else:
                        print(f"‚ö†Ô∏è Row index {row_index} out of range in {datafile}")
                except Exception as e:
                    print(f"‚ùå Invalid row index: {rows} ‚Äî {e}")

        case _:
            print(f"‚ö†Ô∏è Unknown SCENARIO type: {scenario}")


def run_driver():
    if not mapping_file or not os.path.exists(mapping_file):
        print(f"‚ùå Mapping file not found or not set: {mapping_file}")
        return

    try:
        df = pd.read_csv(mapping_file)
    except Exception as e:
        print(f"‚ùå Failed to read mapping file: {e}")
        return

    for idx, row in df.iterrows():
        scenario = str(row.get("SCENARIO", "")).strip()
        execute_flag = str(row.get("EXECUTE", "")).strip().upper()

        if execute_flag != "YES":
            print(f"‚è© Skipping scenario [{scenario}] (EXECUTE != YES)")
            continue

        datafile = str(row.get("DATAFILE1", "")).strip()
        rows = str(row.get("ROWS", "ALL")).strip()

        execute_scenario(scenario, datafile, rows)


if __name__ == "__main__":
    run_driver()
