import pandas as pd
import xml.etree.ElementTree as ET
import os
import pyodbc
import subprocess
from dotenv import load_dotenv
from auth import get_auth

# Load environment variables
load_dotenv()
cdw_username = os.getenv("CDW_USERNAME")
cdw_password = os.getenv("CDW_PASSWORD")

# Input/Output files
input_file = "shared/input/input_filenames.xlsx"
sheet_name = "TradesInFile"
output_file = "shared/reports/trades_validation_report.xlsx"

def fetch_cdw_response(cdw_url, username, password):
    try:
        command = ['curl', '-u', f'{username}:{password}', cdw_url]
        result = subprocess.run(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True, timeout=60)
        return result.stdout if result.returncode == 0 else None
    except Exception:
        return None

def validate_book_in_db(server, db, table, column, book_ref):
    try:
        conn = pyodbc.connect(
            f"DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={db};Trusted_Connection=yes"
        )
        cursor = conn.cursor()
        query = f"SELECT 1 FROM {table} WHERE {column} = ?"
        cursor.execute(query, (book_ref,))
        return "FOUND" if cursor.fetchone() else "MISSING"
    except Exception:
        return "ERROR"

def extract_book_from_cdw(xml_data):
    try:
        root = ET.fromstring(xml_data)
        ns = {'fpml': 'http://www.fpml.org/FpML-5/reporting'}
        accounts = root.findall(".//fpml:account[@id='HOUSE-ACCOUNT']", namespaces=ns)
        if accounts:
            account_node = accounts[-1]
            book_ref_node = account_node.find(".//fpml:accountId[@accountIdScheme='mhi:book-ref']", namespaces=ns)
            book_type_node = account_node.find(".//fpml:accountId[@accountIdScheme='mhi:book-type']", namespaces=ns)
            if book_ref_node is not None and book_type_node is not None:
                return book_ref_node.text.strip(), book_type_node.text.strip(), None
            else:
                return None, None, "Missing book-ref or book-type in account node"
        else:
            return None, None, "HOUSE-ACCOUNT node not found"
    except ET.ParseError as e:
        return None, None, f"XML ParseError: {str(e)}"
    except Exception as e:
        return None, None, f"XML Error: {str(e)}"

def process_trades():
    df = pd.read_excel(input_file, sheet_name=sheet_name)
    results = []

    for _, row in df.iterrows():
        file_type = str(row.get("FileType", "")).strip().upper()
        filename = str(row.get("Filename", "")).strip()
        trades_str = str(row.get("Trades", "")).strip()
        trade_ids = [t.strip() for t in trades_str.split(",") if t.strip()]
        cdw_base_url = str(row.get("CDWURL", "")).strip()
        reporting_date = str(row.get("BatchDate", "")).strip()
        server = str(row.get("DatabaseInstanceName", "")).strip()
        db = str(row.get("Databasename", "")).strip()
        table = str(row.get("Tablename", "")).strip()
        column = str(row.get("ColumnNameForBookRef", "")).strip()

        for trade_id in trade_ids:
            trade_found = "MISSING"
            book_ref_in_cdw = "-"
            cdw_url = f"{cdw_base_url}/{trade_id}?on={reporting_date}"
            query_used = f"-- CDW URL: {cdw_url}"
            comments = ""

            try:
                # STEP 1: Search in MBE_POSITION_SET file
                file_df = pd.read_csv(filename, delimiter="|", dtype=str, engine="python")
                file_df = file_df.applymap(lambda x: x.strip() if isinstance(x, str) else x)
                file_df["M_ORIGIN_RE"] = file_df["M_ORIGIN_RE"].astype(str).str.strip()
                file_df["BOOK_ID"] = file_df["BOOK_ID"].astype(str).str.strip()

                match_row = file_df[file_df["M_ORIGIN_RE"] == trade_id]
                if not match_row.empty:
                    trade_found = "FOUND"
                    file_book_ref = match_row["BOOK_ID"].values[0].strip()

                    # STEP 2: Fetch from CDW
                    xml_data = fetch_cdw_response(cdw_url, cdw_username, cdw_password)
                    if xml_data:
                        book_ref, book_type, err = extract_book_from_cdw(xml_data)
                        if book_ref and book_type:
                            book_ref_in_cdw = f"{book_ref} {book_type}"
                            query_used = f"SELECT DISTINCT M_PORTFOLIO FROM DF WHERE M_PORTFOLIO IN ('{book_ref_in_cdw}')"
                            comments = book_ref_in_cdw
                            # STEP 3: DB Validation
                            book_db_result = validate_book_in_db(server, db, table, column, book_ref_in_cdw)
                            comments += f" | BookRef DB Check: {book_db_result}"
                        else:
                            comments = err or "BookRef not extracted"
                            query_used += " -- Missing book-ref/book-type"
                    else:
                        comments = "CDW fetch failed or empty response"
                        query_used += " -- CDW fetch failed"
                else:
                    comments = "TradeID not found in MBE_POSITION_SET file"
                    query_used += " -- M_ORIGIN_RE not found"

            except Exception as e:
                comments = f"Exception occurred: {str(e)}"
                query_used += " -- Exception during validation"

            results.append({
                "FileType": file_type,
                "Filename": filename,
                "TradeID": trade_id,
                "TradeFound": trade_found,
                "CDWURL": cdw_url,
                "BOOKREF_INCDW": book_ref_in_cdw,
                "Query_Used": query_used,
                "Comments": comments
            })

    pd.DataFrame(results).to_excel(output_file, index=False)
    print(f"âœ… Report generated: {output_file}")

if __name__ == "__main__":
    process_trades()
